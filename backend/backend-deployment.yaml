# ============================================
# DEPLOYMENT MANIFEST
# A Deployment manages a set of identical Pods
# ============================================

apiVersion: apps/v1
kind: Deployment

# --------------------------------------------
# DEPLOYMENT METADATA
# This is information about the Deployment itself
# --------------------------------------------
metadata:
  name: backend-deployment        # Name of this Deployment

# --------------------------------------------
# DEPLOYMENT SPECIFICATION
# Defines how the Deployment should behave
# --------------------------------------------
spec:
  replicas: 2                     # Create and maintain 2 identical Pods

  # ROLLING UPDATE STRATEGY
  # How to update Pods when changes are made
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1                 # Max 1 extra Pod during update
      maxUnavailable: 1           # Max 1 Pod can be unavailable during update

  # ==========================================
  # SELECTOR - How Deployment finds its Pods
  # ==========================================
  # This tells the Deployment: "Manage all Pods that have the label app=backend"
  # The Deployment uses this to know which Pods belong to it
  selector:
    matchLabels:
      app: backend                # Must match Pod's label below!

  # ==========================================
  # POD TEMPLATE - Blueprint for creating Pods
  # ==========================================
  # Everything below defines what each Pod looks like
  template:
    # ----------------------------------------
    # POD METADATA - Labels for the Pod
    # ----------------------------------------
    metadata:
      labels:
        app: backend              # This label is attached to each Pod
                                  # Must match selector above!
                                  # Service also uses this to find Pods

    # ----------------------------------------
    # POD SPECIFICATION - What runs in the Pod
    # ----------------------------------------
    spec:
      containers:
        - name: backend                   # Container name
          image: k8s-demo-backend:v1      # Docker image to use
          imagePullPolicy: Never          # Use local image, don't pull from registry
          
          ports:
            - containerPort: 3001         # Port the container exposes

          # ======================================
          # ENVIRONMENT FROM CONFIGMAP
          # ======================================
          # Load ALL keys from ConfigMap as env vars
          envFrom:
            - configMapRef:
                name: backend-config      # Reference to ConfigMap

          # ======================================
          # ENVIRONMENT FROM SECRET
          # ======================================
          # Load specific secret values
          env:
            - name: DB_PASSWORD           # Env var name in container
              valueFrom:
                secretKeyRef:
                  name: backend-secret    # Reference to Secret
                  key: DB_PASSWORD        # Key in the Secret
            
            - name: API_KEY
              valueFrom:
                secretKeyRef:
                  name: backend-secret
                  key: API_KEY
            
            - name: JWT_SECRET
              valueFrom:
                secretKeyRef:
                  name: backend-secret
                  key: JWT_SECRET

# ============================================
# DEPLOYMENT ORDER:
# 1. First apply ConfigMap:  kubectl apply -f backend-configmap.yaml
# 2. Then apply Secret:      kubectl apply -f backend-secret.yaml
# 3. Finally Deployment:     kubectl apply -f backend-deployment.yaml
#
# Or all at once:
# kubectl apply -f backend-configmap.yaml -f backend-secret.yaml -f backend-deployment.yaml
# ============================================
